<!--
  templateType: blog_post
  label: Blog Post
  isAvailableForNewContent: true
  screenshotPath: ../images/template-previews/blog-post.png
-->
{% extends "../layouts/base.html" %}

{% block body %}
<main class="blog-post">
  {# Post Header #}
  <header class="blog-post__header">
    <div class="container">
      <div class="blog-post__header-content">
        {# Categories #}
        {% if content.topic_list %}
          <div class="blog-post__categories">
            {% for topic in content.topic_list %}
              <a href="{{ blog_tag_url(group.id, topic.slug) }}" class="blog-post__category-link">
                {{ topic.name }}
              </a>
            {% endfor %}
          </div>
        {% endif %}

        {# Title #}
        <h1 class="blog-post__title">{{ content.name }}</h1>

        {# Meta #}
        <div class="blog-post__meta">
          {% if content.blog_author %}
            <div class="blog-post__author">
              {% if content.blog_author.avatar %}
                <img src="{{ content.blog_author.avatar }}" alt="{{ content.blog_author.display_name }}" class="blog-post__author-image" loading="lazy">
              {% else %}
                <div class="blog-post__author-placeholder">{{ content.blog_author.display_name|first|upper }}</div>
              {% endif %}
              <div class="blog-post__author-info">
                <span class="blog-post__author-name">{{ content.blog_author.display_name }}</span>
                {% if content.publish_date %}
                <time class="blog-post__date" datetime="{{ content.publish_date|datetimeformat('%Y-%m-%d') }}">
                  {{ content.publish_date|datetimeformat('%B %d, %Y') }}
                </time>
                {% endif %}
              </div>
            </div>
          {% endif %}

          {# Reading Time #}
          {% set word_count = content.post_body|striptags|wordcount %}
          {% set read_time = (word_count / 200)|round(0, 'ceil')|int %}
          {% if read_time < 1 %}{% set read_time = 1 %}{% endif %}
          <span class="blog-post__read-time">{{ read_time }} min read</span>
        </div>
      </div>
    </div>
  </header>

  {# Featured Image #}
  {% if content.featured_image %}
    <div class="blog-post__featured-image">
      <img src="{{ content.featured_image }}" alt="{{ content.featured_image_alt_text|default(content.name) }}" loading="eager">
    </div>
  {% endif %}

  {# Post Content #}
  <section class="blog-post__content">
    <div class="container">
      <div class="blog-post__layout">
        {# Main Content #}
        <div class="blog-post__body">
          <article class="blog-post__article">
            {{ content.post_body }}
          </article>

          {# Tags #}
          {% if content.tag_list %}
            <div class="blog-post__tags">
              {% for tag in content.tag_list %}
                <a href="{{ blog_tag_url(group.id, tag.slug) }}" class="blog-post__tag">
                  #{{ tag.name }}
                </a>
              {% endfor %}
            </div>
          {% endif %}

          {# Author Bio #}
          {% if content.blog_author %}
            <div class="blog-post__author-bio">
              <div class="author-bio">
                <div class="author-bio__avatar">
                  {% if content.blog_author.avatar %}
                    <img src="{{ content.blog_author.avatar }}" alt="{{ content.blog_author.display_name }}" class="author-bio__image">
                  {% else %}
                    <div class="author-bio__placeholder">{{ content.blog_author.display_name|first|upper }}</div>
                  {% endif %}
                </div>
                <div class="author-bio__content">
                  <span class="author-bio__label">Written by</span>
                  <h3 class="author-bio__name">{{ content.blog_author.display_name }}</h3>
                  {% if content.blog_author.bio %}
                    <p class="author-bio__description">{{ content.blog_author.bio }}</p>
                  {% endif %}
                  <div class="author-bio__social">
                    {% if content.blog_author.twitter %}
                      <a href="https://twitter.com/{{ content.blog_author.twitter }}" class="author-bio__social-link" target="_blank" rel="noopener" aria-label="Twitter">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                      </a>
                    {% endif %}
                    {% if content.blog_author.linkedin %}
                      <a href="{{ content.blog_author.linkedin }}" class="author-bio__social-link" target="_blank" rel="noopener" aria-label="LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                          <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                      </a>
                    {% endif %}
                    {% if content.blog_author.website %}
                      <a href="{{ content.blog_author.website }}" class="author-bio__social-link" target="_blank" rel="noopener" aria-label="Website">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                          <circle cx="12" cy="12" r="10"></circle>
                          <line x1="2" y1="12" x2="22" y2="12"></line>
                          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                      </a>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          {# Post Navigation #}
          <nav class="blog-post__nav">
            {% set prev_post = blog_recent_posts(group.id, 1, content.id) %}
            {% set next_post = blog_recent_posts(group.id, 1) %}

            {# This is a simplified nav - in production you'd query for actual prev/next #}
            <a href="{{ group.absolute_url }}" class="blog-post__nav-link blog-post__nav-link--back">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              <span>Back to Blog</span>
            </a>
          </nav>
        </div>

        {# Sidebar #}
        <aside class="blog-post__sidebar">
          {# Table of Contents #}
          <div class="blog-post__toc">
            <h4 class="blog-post__toc-title">Table of Contents</h4>
            <nav class="blog-post__toc-nav" id="toc-nav">
              {# TOC will be generated via JavaScript from h2/h3 headings #}
              <p class="blog-post__toc-empty">Loading...</p>
            </nav>
          </div>

          {# Share Links #}
          <div class="blog-post__share">
            <h4 class="blog-post__share-title">Share</h4>
            <div class="blog-post__share-links">
              <a href="https://twitter.com/intent/tweet?url={{ content.absolute_url|urlencode }}&text={{ content.name|urlencode }}" class="blog-post__share-link blog-post__share-link--twitter" target="_blank" rel="noopener" aria-label="Share on Twitter">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
              </a>
              <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ content.absolute_url|urlencode }}" class="blog-post__share-link blog-post__share-link--linkedin" target="_blank" rel="noopener" aria-label="Share on LinkedIn">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
              </a>
              <a href="mailto:?subject={{ content.name|urlencode }}&body={{ content.absolute_url|urlencode }}" class="blog-post__share-link blog-post__share-link--email" aria-label="Share via Email">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
              </a>
              <button type="button" class="blog-post__share-link blog-post__share-link--copy" data-url="{{ content.absolute_url }}" aria-label="Copy link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
              </button>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </section>

  {# Related Posts #}
  {% set related_posts = blog_recent_posts(group.id, 3, content.id) %}
  {% if related_posts %}
    <section class="blog-post__related">
      <div class="container">
        <h2 class="blog-post__related-title">Related Posts</h2>
        <div class="blog-post__related-grid">
          {% for post in related_posts %}
            <article class="blog-card">
              <a href="{{ post.absolute_url }}" class="blog-card__image-link">
                <div class="blog-card__image-wrapper">
                  {% if post.featured_image %}
                    <img src="{{ post.featured_image }}" alt="{{ post.featured_image_alt_text|default(post.name) }}" class="blog-card__image" loading="lazy">
                  {% else %}
                    <div class="blog-card__placeholder">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                      </svg>
                    </div>
                  {% endif %}
                </div>
              </a>

              <div class="blog-card__content">
                {% if post.topic_list %}
                  <div class="blog-card__category">
                    {% for topic in post.topic_list %}
                      <a href="{{ blog_tag_url(group.id, topic.slug) }}" class="blog-card__category-link">
                        {{ topic.name }}
                      </a>
                      {% if not loop.last %}<span class="blog-card__category-sep">,</span>{% endif %}
                    {% endfor %}
                  </div>
                {% endif %}

                <h3 class="blog-card__title">
                  <a href="{{ post.absolute_url }}" class="blog-card__title-link">
                    {{ post.name }}
                  </a>
                </h3>

                <div class="blog-card__meta">
                  <div class="blog-card__details">
                    {% if post.publish_date %}
                    <time class="blog-card__date" datetime="{{ post.publish_date|datetimeformat('%Y-%m-%d') }}">
                      {{ post.publish_date|datetimeformat('%B %d, %Y') }}
                    </time>
                    {% endif %}
                  </div>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      </div>
    </section>
  {% endif %}

  {# CTA Section #}
  {% module "blog_cta"
    path="../modules/content/cta.module",
    label="Blog CTA"
  %}
</main>

{# Table of Contents Script #}
<script>
(function() {
  'use strict';

  function buildTOC() {
    var article = document.querySelector('.blog-post__article');
    var tocNav = document.getElementById('toc-nav');

    if (!article || !tocNav) return;

    var headings = article.querySelectorAll('h2, h3');

    if (headings.length === 0) {
      tocNav.innerHTML = '<p class="blog-post__toc-empty">No sections found</p>';
      return;
    }

    var tocList = document.createElement('ul');
    tocList.className = 'blog-post__toc-list';

    headings.forEach(function(heading, index) {
      // Add ID to heading if it doesn't have one
      if (!heading.id) {
        heading.id = 'section-' + index;
      }

      var listItem = document.createElement('li');
      listItem.className = 'blog-post__toc-item blog-post__toc-item--' + heading.tagName.toLowerCase();

      var link = document.createElement('a');
      link.href = '#' + heading.id;
      link.className = 'blog-post__toc-link';
      link.textContent = heading.textContent;

      listItem.appendChild(link);
      tocList.appendChild(listItem);
    });

    tocNav.innerHTML = '';
    tocNav.appendChild(tocList);

    // Smooth scroll for TOC links
    tocNav.addEventListener('click', function(e) {
      if (e.target.tagName === 'A') {
        e.preventDefault();
        var targetId = e.target.getAttribute('href').substring(1);
        var target = document.getElementById(targetId);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          history.pushState(null, null, '#' + targetId);
        }
      }
    });
  }

  // Copy link functionality
  function initCopyLink() {
    var copyBtn = document.querySelector('.blog-post__share-link--copy');
    if (copyBtn) {
      copyBtn.addEventListener('click', function() {
        var url = this.dataset.url;
        navigator.clipboard.writeText(url).then(function() {
          copyBtn.classList.add('blog-post__share-link--copied');
          setTimeout(function() {
            copyBtn.classList.remove('blog-post__share-link--copied');
          }, 2000);
        });
      });
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      buildTOC();
      initCopyLink();
    });
  } else {
    buildTOC();
    initCopyLink();
  }
})();
</script>
{% endblock body %}

{% block body_classes %}blog-post-page{% endblock %}
